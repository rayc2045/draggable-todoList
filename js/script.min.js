"use strict";class TodoApp{constructor(){this.todoList=JSON.parse(localStorage.getItem("todoList"))||[{task:"è¨»è¨˜å®Œæˆçš„ä»»å‹™æœƒä»¥åˆªé™¤ç·šè¡¨ç¤º",completed:!0},{task:'å¯ä½¿ç”¨ä»»å‹™å·¦å´ ": :" ç¬¦è™Ÿæ‹–æ›³é …ç›®',completed:!1},{task:'å¯ä½¿ç”¨ä»»å‹™å³å´ "âœ•" ç¬¦è™Ÿåˆªé™¤é …ç›®',completed:!1},{task:"é»žæ“Šä»»å‹™å¾Œå³å¯é€²è¡Œç·¨è¼¯ï¼Œå®Œæˆå¾ŒæŒ‰ä¸‹ Enter éµå°‡ä¿å­˜ç´€éŒ„",completed:!1},{task:"é»žæ“Šæ­¤ä»»å‹™æŸ¥çœ‹å¦‚ä½• [é™„åŠ é€£çµ](https://rayc2045.github.io/raychang-space/)",completed:!1},{task:"ä»»ä½•æ›´å‹•å°‡è‡ªå‹•å„²å­˜ï¼Œé—œæŽ‰ç¶²é ä¹Ÿä¸ä¸Ÿå¤±ç´€éŒ„",completed:!1},{task:"ä½¿ç”¨ [1-3-5 æ³•å‰‡](https://www.themuse.com/advice/a-better-todo-list-the-135-rule) èšç„¦æ‚¨ä¸€å¤©çš„é‡å¿ƒï¼Œä¸¦é–‹å§‹æ–°å¢žç¬¬ä¸€é …ä»»å‹™ ðŸ™‚",completed:!1}],this.itemsParentEl=document.querySelector(".items"),this.itemEls=this.itemsParentEl.childNodes,this.newItemInputEl=document.querySelector(".new-item-input"),this.maxTaskNumber=10,this.accomplishSound=new Audio("https://raw.githubusercontent.com/rayc2045/draggable-localStorage-todoList/master/audio/BOTW_Fanfare_SmallItem.wav"),this.deleteSound=new Audio("https://raw.githubusercontent.com/rayc2045/draggable-localStorage-todoList/master/audio/BotW_Interact_sound.mp3"),this.dragSound=new Audio("https://raw.githubusercontent.com/rayc2045/draggable-localStorage-todoList/master/audio/drag.mp3"),this.dropSound=new Audio("https://raw.githubusercontent.com/rayc2045/draggable-localStorage-todoList/master/audio/drop.mp3"),this.events()}events(){this.updateTasks(),this.sortableJS(),this.itemsParentEl.onchange=()=>this.rearrangeTodoList(),this.itemsParentEl.ondragstart=e=>e.target.style.height=`${e.target.scrollHeight}px`,this.itemsParentEl.ondragend=()=>{this.itemEls.forEach(el=>{el.removeAttribute("draggable"),el.removeAttribute("style")})},this.itemsParentEl.onmousedown=e=>{if(e.target.classList.contains("handle"))return this.playSound(this.dragSound);e.target.classList.contains("content")&&(this.editEnable(e),e.target.closest(".item").removeAttribute("draggable"),e.target.closest(".item").removeAttribute("style"),e.target.onblur=e=>{if(!e.target.textContent.trim())return this.deleteTask(e);this.saveContent(e),this.editDisable(e)})},this.itemsParentEl.onpaste=e=>{e.target.classList.contains("content")&&this.pastePlainText(e)},this.itemsParentEl.onkeydown=e=>{e.target.classList.contains("content")&&13===e.which&&this.newItemInputEl.focus()},this.itemsParentEl.onclick=e=>{if("checkbox"===e.target.type)return this.toggleComplete(e);e.target.classList.contains("delete")&&this.deleteTask(e)},this.newItemInputEl.onkeydown=e=>{if(this.itemEls.length>=this.maxTaskNumber)return this.inputDisable(e);13===e.which&&this.addTask()}}pastePlainText(e){e.preventDefault();let text=(e.clipboardData||window.clipboardData).getData("text/plain");document.queryCommandSupported("insertText")?document.execCommand("insertText",!1,text):document.execCommand("paste",!1,text)}convertToAnchor(text){return this.getFilteredText(text).replace(/(<([^>]+)>)/gi,"").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,'<a href="$2" target="_blank" rel="noreferrer noopener">$1</a>')}convertToMarkdown(anchor){return this.getFilteredText(anchor).replace(/(<\/?(?:a)[^>]*>)|<[^>]+>/gi,"$1").replace(/<a.*?href="(.*?)".*?>(.*?)<\/a>/g,"[$2]($1)")}getFilteredText(text){return String(text).replace(/%3C/gi,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"')}updateTasks(){this.itemsParentEl.innerHTML="";for(const i in this.todoList){const item=document.createElement("li");item.id=`item_${i}`,item.classList.add("item"),item.innerHTML=`\n        <div class="handle">: :</div>\n        <input type="checkbox"${this.todoList[i].completed?" checked":""}>\n        <div class="check">âœ“</div>\n        <div class="content">${this.convertToAnchor(this.todoList[i].task)}</div>\n        <div class="delete">âœ•</div>`,this.itemsParentEl.appendChild(item)}this.setPlaceholder(this.maxTaskNumber)}setPlaceholder(maxNumber){this.itemEls.length<maxNumber?this.newItemInputEl.placeholder="What needs to be done?":this.newItemInputEl.placeholder="Try to make tasks less..."}addTask(){const input=this.newItemInputEl.value.trim();if(!input)return this.newItemInputEl.value="";this.todoList.push({task:this.getFilteredText(input).replace(/(<([^>]+)>)/gi,""),completed:!1}),this.setLocalStorage("todoList",this.todoList),this.updateTasks(),this.newItemInputEl.value="",this.playSound(this.dropSound)}inputDisable(e){e.preventDefault(),e.target.value=""}deleteTask(e){const item=e.target.closest(".item"),index=item.id.replace("item_","");this.todoList.splice(index,1),this.todoList.length?this.setLocalStorage("todoList",this.todoList):this.removeFromLocalStorage("todoList"),this.updateTasks(),this.playSound(this.deleteSound)}toggleComplete(e){e.preventDefault();const index=e.target.closest(".item").id.replace("item_","");if(this.todoList[index].completed=!this.todoList[index].completed,this.setLocalStorage("todoList",this.todoList),this.updateTasks(),!e.target.checked)return this.muteGradually(this.accomplishSound);this.playSound(this.accomplishSound,.35)}editEnable(e){e.target.contentEditable="true",e.target.innerHTML=this.convertToMarkdown(e.target.innerHTML)}editDisable(e){e.target.removeAttribute("contenteditable"),e.target.innerHTML=this.convertToAnchor(e.target.innerHTML)}saveContent(e){const index=e.target.closest(".item").id.replace("item_","");this.todoList[index].task=this.convertToMarkdown(e.target.innerHTML),this.setLocalStorage("todoList",this.todoList)}sortableJS(){Sortable.create(sortable,{animation:100,handle:".handle",draggable:".item",ghostClass:"dragging"})}rearrangeTodoList(){for(const i in this.todoList)this.todoList[i].completed=this.itemEls[i].childNodes[3].checked,this.todoList[i].task=this.convertToMarkdown(this.itemEls[i].childNodes[7].innerHTML),this.setLocalStorage("todoList",this.todoList),this.itemEls[i].id=`item_${i}`,this.playSound(this.dropSound)}setLocalStorage(title,data){localStorage.setItem(title,JSON.stringify(data))}removeFromLocalStorage(title){localStorage.removeItem(title)}playSound(audio,volume=1){audio.currentTime=0,audio.volume=volume,audio.play()}muteGradually(audio){for(let i=0;i<10;i++){let delay;setTimeout(()=>{audio.volume/=1.65},50*i)}}}new TodoApp;